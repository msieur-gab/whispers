<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Decryption (Reader Password Access)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
        .container { max-width: 700px; margin: 20px auto; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2, h3 { color: #1a202c; }
        h2 { border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-top: 20px; }
        label { display: block; margin-top: 10px; font-weight: 600; color: #4a5568; }
        input[type="password"], textarea, input[type="file"] {
            width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #cbd5e0; border-radius: 4px;
            box-sizing: border-box; font-size: 14px;
        }
        input[type="file"] {
            padding: 8px; /* Slightly less padding for file input */
            background-color: #fff; /* Ensure background for file input */
        }
        /* Style the file input button provided by the browser */
        input[type="file"]::file-selector-button {
            background-color: #4299e1;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
            transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #3182ce;
        }
        textarea { min-height: 100px; font-family: monospace; white-space: pre-wrap; word-break: break-all; }
        button {
            background-color: #4299e1; color: white; padding: 10px 15px; border: none; border-radius: 4px;
            cursor: pointer; font-weight: 600; margin-top: 15px; transition: background-color 0.2s;
        }
        button:hover { background-color: #3182ce; }
        button:disabled { background-color: #a0aec0; cursor: not-allowed; }
        .info, .error {
            padding: 10px; margin-top: 10px; border-radius: 4px; font-size: 0.9em;
        }
        .info { background-color: #e6fffa; border: 1px solid #38b2ac; color: #2c7a7b; }
        .error { background-color: #fed7d7; border: 1px solid #f56565; color: #c53030; }
        .decryption-mode-selector button { background-color: #667eea; margin-right: 10px; }
        .decryption-mode-selector button.active { background-color: #4c51bf; font-weight: bold; }
        .hidden-section { display: none; }
        .file-upload-area { margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-700">Survey Decryption</h1>
        <div id="status" class="hidden"></div>

        <div class="file-upload-area">
            <label for="uploadFile">Or upload the encrypted JSON package file:</label>
            <input type="file" id="uploadFile" accept=".json" class="mt-1">
        </div>

        <div>
            <label for="encryptedPackageInput">Paste the encrypted JSON package here:</label>
            <textarea id="encryptedPackageInput" rows="8" placeholder="The JSON generated by the survey application... or upload a file above."></textarea>
        </div>

        <div class="decryption-mode-selector mt-4 mb-4">
            <h3 class="text-lg font-semibold mb-2">Choose decryption mode:</h3>
            <button id="decryptAsUserBtn" class="active">As User (with my password)</button>
            <button id="decryptAsReaderBtn">As Reader (with reader password)</button>
        </div>

        <div id="user-decryption-section">
            <label for="userPasswordInput">Your password (from the survey):</label>
            <input type="password" id="userPasswordInput" placeholder="Password used during encryption">
        </div>

        <div id="reader-decryption-section" class="hidden-section">
            <label for="readerPasswordInput">Reader's Password:</label>
            <input type="password" id="readerPasswordInput" placeholder="Password provided for reader access">
        </div>

        <button id="decryptBtn" class="bg-green-500 hover:bg-green-600 w-full mt-4">Decrypt Answers</button>

        <div id="result-area" class="hidden mt-6">
            <h3 class="text-xl font-semibold">Decrypted Answers:</h3>
            <textarea id="decryptedAnswersOutput" rows="10" readonly class="bg-gray-100"></textarea>
        </div>
    </div>

    <script>
        // --- UTILITIES ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        const statusDiv = document.getElementById('status');
        function showStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.className = isError ? 'error' : 'info';
            statusDiv.classList.remove('hidden');
            if (isError) console.error("ERROR:", message); else console.log("INFO:", message);
        }

        // --- DOM ELEMENTS ---
        const encryptedPackageInput = document.getElementById('encryptedPackageInput');
        const uploadFileInput = document.getElementById('uploadFile'); // New file input element
        const decryptAsUserBtn = document.getElementById('decryptAsUserBtn');
        const decryptAsReaderBtn = document.getElementById('decryptAsReaderBtn');
        const userDecryptionSection = document.getElementById('user-decryption-section');
        const readerDecryptionSection = document.getElementById('reader-decryption-section');
        const userPasswordInput = document.getElementById('userPasswordInput');
        const readerPasswordInput = document.getElementById('readerPasswordInput');
        const decryptBtn = document.getElementById('decryptBtn');
        const resultArea = document.getElementById('result-area');
        const decryptedAnswersOutput = document.getElementById('decryptedAnswersOutput');

        let currentDecryptionMode = 'user'; 

        // --- EVENT LISTENERS ---

        // Event listener for file input change
        uploadFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const fileContent = e.target.result;
                        // Attempt to parse to ensure it's valid JSON before putting in textarea
                        JSON.parse(fileContent); 
                        encryptedPackageInput.value = fileContent;
                        showStatus(`File "${file.name}" loaded successfully.`, false);
                    } catch (err) {
                        showStatus(`Error reading file: ${file.name}. Is it a valid JSON file? ${err.message}`, true);
                        encryptedPackageInput.value = ''; // Clear textarea if file is invalid
                    }
                };
                reader.onerror = () => {
                    showStatus(`Error reading file: ${file.name}.`, true);
                    encryptedPackageInput.value = '';
                };
                reader.readAsText(file);
            }
        });

        // Event listener for "Decrypt as User" button
        decryptAsUserBtn.addEventListener('click', () => {
            currentDecryptionMode = 'user';
            decryptAsUserBtn.classList.add('active');
            decryptAsReaderBtn.classList.remove('active');
            userDecryptionSection.classList.remove('hidden-section');
            readerDecryptionSection.classList.add('hidden-section');
        });

        // Event listener for "Decrypt as Reader" button
        decryptAsReaderBtn.addEventListener('click', () => {
            currentDecryptionMode = 'reader';
            decryptAsReaderBtn.classList.add('active');
            decryptAsUserBtn.classList.remove('active');
            readerDecryptionSection.classList.remove('hidden-section');
            userDecryptionSection.classList.add('hidden-section');
        });
        
        // Event listener for the main "Decrypt Answers" button
        decryptBtn.addEventListener('click', async () => {
            const packageJsonString = encryptedPackageInput.value;
            // Validate if the package JSON is provided
            if (!packageJsonString.trim()) {
                showStatus("Please paste or upload the encrypted JSON package.", true); return;
            }
            let encryptedPackage;
            // Try to parse the JSON package
            try { 
                encryptedPackage = JSON.parse(packageJsonString); 
            } catch (err) { 
                showStatus("The JSON package is invalid: " + err.message, true); return; 
            }

            let dek; // Data Encryption Key
            try {
                showStatus("Decrypting...", false);
                decryptBtn.disabled = true; // Disable button during processing
                resultArea.classList.add('hidden'); // Hide previous results

                let relevantEncryptionInfo;
                let passwordToUse;

                // Determine which encryption info and password to use based on the selected mode
                if (currentDecryptionMode === 'user') {
                    relevantEncryptionInfo = encryptedPackage.userEncryptionInfo;
                    passwordToUse = userPasswordInput.value;
                    if (!passwordToUse) { showStatus("Please enter your password.", true); throw new Error("User password missing");}
                    if (!relevantEncryptionInfo) { showStatus("User encryption info not found in the package.", true); throw new Error("userEncryptionInfo missing");}
                } else if (currentDecryptionMode === 'reader') {
                    relevantEncryptionInfo = encryptedPackage.readerEncryptionInfo;
                    passwordToUse = readerPasswordInput.value;
                    if (!passwordToUse) { showStatus("Please enter the reader password.", true); throw new Error("Reader password missing");}
                    if (!relevantEncryptionInfo) { showStatus("Reader encryption info not found in the package (it may not have been encrypted for a reader).", true); throw new Error("readerEncryptionInfo missing");}
                } else {
                    throw new Error("Unknown decryption mode selected.");
                }

                // Decode salt, IV for DEK, and the encrypted DEK from base64
                const salt = base64ToArrayBuffer(relevantEncryptionInfo.salt_base64);
                const iv_dek = base64ToArrayBuffer(relevantEncryptionInfo.iv_base64);
                const encryptedDek_bytes = base64ToArrayBuffer(relevantEncryptionInfo.encryptedDek_base64);

                // Import the password material for PBKDF2
                const passwordKeyMaterial = await window.crypto.subtle.importKey(
                    "raw", new TextEncoder().encode(passwordToUse), "PBKDF2", false, ["deriveKey"]
                );
                // Derive the AES Key Encryption Key (KEK) from the password
                const aesKek = await window.crypto.subtle.deriveKey(
                    { name: "PBKDF2", salt: salt, iterations: relevantEncryptionInfo.kdfIterations || 250000, hash: "SHA-256" },
                    passwordKeyMaterial, { name: "AES-GCM", length: 256 }, true, ["decrypt"]
                );
                
                // Decrypt the Data Encryption Key (DEK) using the AES KEK
                const dek_raw_buffer = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv_dek }, aesKek, encryptedDek_bytes
                );
                // Import the raw DEK for use in decrypting the answers
                dek = await window.crypto.subtle.importKey(
                    "raw", dek_raw_buffer, { name: "AES-GCM", length: 256 }, true, ["decrypt"]
                );

                if (!dek) { throw new Error("The Data Encryption Key (DEK) could not be retrieved. Check password and package integrity."); }

                // Decode the encrypted answers and its IV from base64
                const encryptedAnswers = base64ToArrayBuffer(encryptedPackage.encryptedAnswers_base64);
                const data_iv = base64ToArrayBuffer(encryptedPackage.data_iv_base64);
                // Decrypt the actual answers data using the DEK
                const decryptedAnswersBuffer = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: data_iv }, dek, encryptedAnswers
                );
                // Decode the decrypted answers from UTF-8 and parse as JSON
                const decryptedAnswersString = new TextDecoder().decode(decryptedAnswersBuffer);
                const answersObject = JSON.parse(decryptedAnswersString);

                // Format and display the decrypted answers
                let formattedAnswers = "Survey Answers:\n==========================\n"; // Changed here
                for (const qId in answersObject) {
                    // Assuming 'question' and 'answer' keys exist in answersObject[qId]
                    const questionText = answersObject[qId].question || `Question ID: ${qId}`; // Fallback if question text is missing
                    const answerText = answersObject[qId].answer !== undefined ? answersObject[qId].answer : "N/A"; // Handle undefined answers
                    formattedAnswers += `\nQuestion: ${questionText}\nAnswer: ${answerText}\n--------------------------\n`;
                }
                decryptedAnswersOutput.value = formattedAnswers;
                resultArea.classList.remove('hidden');
                showStatus("Answers decrypted successfully!", false);

            } catch (err) {
                // Show error message if decryption fails
                showStatus("Error during decryption: " + err.message + ". Please check the password and the integrity of the JSON package.", true);
            } finally {
                // Re-enable the decrypt button
                decryptBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
